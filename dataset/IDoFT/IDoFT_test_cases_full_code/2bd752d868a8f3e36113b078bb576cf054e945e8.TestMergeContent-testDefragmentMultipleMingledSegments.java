@Test public void testDefragmentMultipleMingledSegments() throws IOException {
  final TestRunner runner=TestRunners.newTestRunner(new MergeContent());
  runner.setProperty(MergeContent.MERGE_STRATEGY,MergeContent.MERGE_STRATEGY_DEFRAGMENT);
  runner.setProperty(MergeContent.MAX_BIN_AGE,"1 min");
  final Map<String,String> attributes=new HashMap<>();
  attributes.put(MergeContent.FRAGMENT_ID_ATTRIBUTE,"1");
  attributes.put(MergeContent.FRAGMENT_COUNT_ATTRIBUTE,"4");
  final Map<String,String> secondAttrs=new HashMap<>();
  secondAttrs.put(MergeContent.FRAGMENT_ID_ATTRIBUTE,"TWO");
  secondAttrs.put(MergeContent.FRAGMENT_COUNT_ATTRIBUTE,"3");
  attributes.put(MergeContent.FRAGMENT_INDEX_ATTRIBUTE,"1");
  runner.enqueue("A Man ".getBytes("UTF-8"),attributes);
  attributes.put(MergeContent.FRAGMENT_INDEX_ATTRIBUTE,"2");
  runner.enqueue("A Plan ".getBytes("UTF-8"),attributes);
  secondAttrs.put(MergeContent.FRAGMENT_INDEX_ATTRIBUTE,"1");
  runner.enqueue("No x ".getBytes("UTF-8"),secondAttrs);
  secondAttrs.put(MergeContent.FRAGMENT_INDEX_ATTRIBUTE,"2");
  runner.enqueue("in ".getBytes("UTF-8"),secondAttrs);
  secondAttrs.put(MergeContent.FRAGMENT_INDEX_ATTRIBUTE,"3");
  runner.enqueue("Nixon".getBytes("UTF-8"),secondAttrs);
  attributes.put(MergeContent.FRAGMENT_INDEX_ATTRIBUTE,"3");
  runner.enqueue("A Canal ".getBytes("UTF-8"),attributes);
  attributes.put(MergeContent.FRAGMENT_INDEX_ATTRIBUTE,"4");
  runner.enqueue("Panama".getBytes("UTF-8"),attributes);
  runner.run(1);
  runner.assertTransferCount(MergeContent.REL_MERGED,2);
  final MockFlowFile assembled=runner.getFlowFilesForRelationship(MergeContent.REL_MERGED).get(0);
  assembled.assertContentEquals("A Man A Plan A Canal Panama".getBytes("UTF-8"));
  final MockFlowFile assembledTwo=runner.getFlowFilesForRelationship(MergeContent.REL_MERGED).get(1);
  assembledTwo.assertContentEquals("No x in Nixon".getBytes("UTF-8"));
}
