@Test public void testNodeTracker() throws Exception {
  Abortable abortable=new StubAbortable();
  ZKWatcher zk=new ZKWatcher(TEST_UTIL.getConfiguration(),"testNodeTracker",abortable);
  ZKUtil.createAndFailSilent(zk,zk.getZNodePaths().baseZNode);
  final String node=ZNodePaths.joinZNode(zk.getZNodePaths().baseZNode,Long.toString(ThreadLocalRandom.current().nextLong()));
  final byte[] dataOne=Bytes.toBytes("dataOne");
  final byte[] dataTwo=Bytes.toBytes("dataTwo");
  TestTracker localTracker=new TestTracker(zk,node,abortable);
  localTracker.start();
  zk.registerListener(localTracker);
  assertNull(localTracker.getData(false));
  WaitToGetDataThread thread=new WaitToGetDataThread(zk,node);
  thread.start();
  assertFalse(thread.hasData);
  TestTracker secondTracker=new TestTracker(zk,node,null);
  secondTracker.start();
  zk.registerListener(secondTracker);
  TestingZKListener zkListener=new TestingZKListener(zk,node);
  zk.registerListener(zkListener);
  assertEquals(0,zkListener.createdLock.availablePermits());
  final ZooKeeper zkconn=ZooKeeperHelper.getConnectedZooKeeper(ZKConfig.getZKQuorumServersString(TEST_UTIL.getConfiguration()),60000);
  zkconn.create(node,dataOne,Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
  zkListener.waitForCreation();
  thread.join();
  assertNotNull(localTracker.getData(false));
  assertNotNull(localTracker.blockUntilAvailable());
  assertTrue(Bytes.equals(localTracker.getData(false),dataOne));
  assertTrue(thread.hasData);
  assertTrue(Bytes.equals(thread.tracker.getData(false),dataOne));
  LOG.info("Successfully got data one");
  assertNotNull(secondTracker.getData(false));
  assertNotNull(secondTracker.blockUntilAvailable());
  assertTrue(Bytes.equals(secondTracker.getData(false),dataOne));
  LOG.info("Successfully got data one with the second tracker");
  zkconn.delete(node,-1);
  zkListener.waitForDeletion();
  TestTracker threadTracker=thread.tracker;
  thread=new WaitToGetDataThread(threadTracker);
  thread.start();
  assertFalse(thread.hasData);
  assertNull(secondTracker.getData(false));
  assertNull(localTracker.getData(false));
  LOG.info("Successfully made unavailable");
  zkconn.create(node,dataTwo,Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
  zkListener.waitForCreation();
  thread.join();
  assertNotNull(localTracker.getData(false));
  assertNotNull(localTracker.blockUntilAvailable());
  assertTrue(Bytes.equals(localTracker.getData(false),dataTwo));
  assertNotNull(secondTracker.getData(false));
  assertNotNull(secondTracker.blockUntilAvailable());
  assertTrue(Bytes.equals(secondTracker.getData(false),dataTwo));
  assertTrue(thread.hasData);
  assertTrue(Bytes.equals(thread.tracker.getData(false),dataTwo));
  LOG.info("Successfully got data two on all trackers and threads");
  zkconn.setData(node,dataOne,-1);
  zkListener.waitForDataChange();
  assertNotNull(localTracker.getData(false));
  assertNotNull(localTracker.blockUntilAvailable());
  assertTrue(Bytes.equals(localTracker.getData(false),dataOne));
  assertNotNull(secondTracker.getData(false));
  assertNotNull(secondTracker.blockUntilAvailable());
  assertTrue(Bytes.equals(secondTracker.getData(false),dataOne));
  assertTrue(thread.hasData);
  assertTrue(Bytes.equals(thread.tracker.getData(false),dataOne));
  LOG.info("Successfully got data one following a data change on all trackers and threads");
}
