@Test public void testUpgrade() throws Exception {
rpc.setClusterKey(zkw.getQuorum());//RW
String peerNode=zkStorageUtil.getPeerNode(peerId);//RW
ZKUtil.createWithParents(zkw,peerNode,ReplicationPeerConfigUtil.toByteArray(rpc));//RW
ZKUtil.createWithParents(zkw,tableCFsNode,Bytes.toBytes(tableCFs));//RW
ReplicationPeerConfig actualRpc=ReplicationPeerConfigUtil.parsePeerFrom(ZKUtil.getData(zkw,peerNode));//RW
String actualTableCfs=Bytes.toString(ZKUtil.getData(zkw,tableCFsNode));//RW
assertEquals(rpc.getClusterKey(),actualRpc.getClusterKey());
assertNull(actualRpc.getTableCFsMap());
assertEquals(tableCFs,actualTableCfs);
rpc.setClusterKey(zkw.getQuorum());//RW
peerNode=zkStorageUtil.getPeerNode(peerId);//RW
ZKUtil.createWithParents(zkw,peerNode,ReplicationPeerConfigUtil.toByteArray(rpc));//RW
ZKUtil.createWithParents(zkw,tableCFsNode,Bytes.toBytes(tableCFs));//RW
actualRpc=ReplicationPeerConfigUtil.parsePeerFrom(ZKUtil.getData(zkw,peerNode));//RW
actualTableCfs=Bytes.toString(ZKUtil.getData(zkw,tableCFsNode));//RW
assertEquals(rpc.getClusterKey(),actualRpc.getClusterKey());
assertNull(actualRpc.getTableCFsMap());
assertEquals(tableCFs,actualTableCfs);
rpc.setClusterKey(zkw.getQuorum());//RW
peerNode=zkStorageUtil.getPeerNode(peerId);//RW
ZKUtil.createWithParents(zkw,peerNode,ReplicationPeerConfigUtil.toByteArray(rpc));//RW
ZKUtil.createWithParents(zkw,tableCFsNode,Bytes.toBytes(tableCFs));//RW
actualRpc=ReplicationPeerConfigUtil.parsePeerFrom(ZKUtil.getData(zkw,peerNode));//RW
actualTableCfs=Bytes.toString(ZKUtil.getData(zkw,tableCFsNode));//RW
assertEquals(rpc.getClusterKey(),actualRpc.getClusterKey());
assertNull(actualRpc.getTableCFsMap());
assertEquals(tableCFs,actualTableCfs);
rpc.setClusterKey(zkw.getQuorum());//RW
peerNode=zkStorageUtil.getPeerNode(peerId);//RW
ZKUtil.createWithParents(zkw,peerNode,ReplicationPeerConfigUtil.toByteArray(rpc));//RW
actualRpc=ReplicationPeerConfigUtil.parsePeerFrom(ZKUtil.getData(zkw,peerNode));//RW
actualTableCfs=Bytes.toString(ZKUtil.getData(zkw,tableCFsNode));//RW
assertEquals(rpc.getClusterKey(),actualRpc.getClusterKey());
assertNull(actualRpc.getTableCFsMap());
assertNull(actualTableCfs);
peerNode=zkStorageUtil.getPeerNode(peerId);//RW
actualRpc=ReplicationPeerConfigUtil.parsePeerFrom(ZKUtil.getData(zkw,peerNode));//RW
assertEquals(rpc.getClusterKey(),actualRpc.getClusterKey());
assertEquals(3,tableNameListMap.size());
assertTrue(tableNameListMap.containsKey(tableName1));
assertTrue(tableNameListMap.containsKey(tableName2));
assertTrue(tableNameListMap.containsKey(tableName3));
assertEquals(2,tableNameListMap.get(tableName1).size());
assertEquals("cf1",tableNameListMap.get(tableName1).get(0));
assertEquals("cf2",tableNameListMap.get(tableName1).get(1));
assertEquals(1,tableNameListMap.get(tableName2).size());
assertEquals("cf3",tableNameListMap.get(tableName2).get(0));
assertNull(tableNameListMap.get(tableName3));
peerNode=zkStorageUtil.getPeerNode(peerId);//RW
actualRpc=ReplicationPeerConfigUtil.parsePeerFrom(ZKUtil.getData(zkw,peerNode));//RW
assertEquals(rpc.getClusterKey(),actualRpc.getClusterKey());
assertEquals(2,tableNameListMap.size());
assertTrue(tableNameListMap.containsKey(tableName1));
assertTrue(tableNameListMap.containsKey(tableName2));
assertEquals(2,tableNameListMap.get(tableName1).size());
assertEquals("cf1",tableNameListMap.get(tableName1).get(0));
assertEquals("cf3",tableNameListMap.get(tableName1).get(1));
assertEquals(1,tableNameListMap.get(tableName2).size());
assertEquals("cf2",tableNameListMap.get(tableName2).get(0));
peerNode=zkStorageUtil.getPeerNode(peerId);//RW
actualRpc=ReplicationPeerConfigUtil.parsePeerFrom(ZKUtil.getData(zkw,peerNode));//RW
assertEquals(rpc.getClusterKey(),actualRpc.getClusterKey());
assertNull(tableNameListMap);
peerNode=zkStorageUtil.getPeerNode(peerId);//RW
actualRpc=ReplicationPeerConfigUtil.parsePeerFrom(ZKUtil.getData(zkw,peerNode));//RW
assertEquals(rpc.getClusterKey(),actualRpc.getClusterKey());
assertNull(tableNameListMap);
}