@Test(timeout=20000) public void testConcurrentUpdates() throws IOException, InterruptedException {
tsWrapper.controlScheduler(true);//IT
tsWrapper.awaitTotalTaskAllocations(2);//IT
assertFalse(ti1.isGuaranteed() || ti2.isGuaranteed());
tsWrapper.ts.waitForMessagesSent(1);//IT
assertTrue(ti1.isGuaranteed());
assertFalse(ti1.getLastSetGuaranteed());
assertFalse(ti2.isGuaranteed());
tsWrapper.ts.waitForMessagesSent(1);//IT
assertTrue(ti1.isGuaranteed());
assertTrue(ti2.isGuaranteed());
assertTrue(ti1.isGuaranteed());
assertTrue(ti2.isGuaranteed());
assertTrue(ti1.getLastSetGuaranteed());
assertTrue(ti2.getLastSetGuaranteed());
tsWrapper.ts.waitForMessagesSent(1);//IT
assertTrue(ti1.isGuaranteed());
assertFalse(ti2.isGuaranteed());
assertTrue(ti2.getLastSetGuaranteed());
tsWrapper.ts.waitForMessagesSent(1);//IT
assertFalse(ti1.isGuaranteed());
assertFalse(ti2.isGuaranteed());
assertFalse(ti1.isGuaranteed());
assertFalse(ti2.isGuaranteed());
assertFalse(ti1.getLastSetGuaranteed());
assertFalse(ti2.getLastSetGuaranteed());
tsWrapper.ts.waitForMessagesSent(1);//IT
assertTrue(ti1.isGuaranteed());
assertFalse(ti1.getLastSetGuaranteed());
assertTrue(ti1.isUpdateInProgress());
tsWrapper.ts.assertNoMessagesSent();//IT
assertFalse(ti1.isGuaranteed());
tsWrapper.ts.waitForMessagesSent(1);//IT
assertFalse(ti1.isGuaranteed());
assertTrue(ti1.getLastSetGuaranteed());
assertTrue(ti1.isUpdateInProgress());
tsWrapper.ts.assertNoMessagesSent();//IT
assertTrue(ti1.isGuaranteed());
assertTrue(ti1.getLastSetGuaranteed());
tsWrapper.ts.waitForMessagesSent(1);//IT
assertTrue(ti1.isGuaranteed());
assertFalse(ti1.getLastSetGuaranteed());
assertTrue(ti1.isUpdateInProgress());
tsWrapper.ts.assertNoMessagesSent();//IT
assertTrue(ti1.isGuaranteed());
assertTrue(ti1.getLastSetGuaranteed());
assertFalse(ti1.isUpdateInProgress());
assertEquals(1,tsWrapper.ts.getUnusedGuaranteedCount());
tsWrapper.shutdown();//IT
}